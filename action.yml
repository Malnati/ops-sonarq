# Malnati/ops-literal@v1.0.0
name: "Ops Literal"
description: "Scan with idempotence."
author: "Ricardo Malnati"

branding:
  icon: "eye"
  color: "orange"

inputs:
  token:
    description: "GitHub token."
    required: true
  file_extensions:
    description: "Regex of extensions."
    required: false
    default: "ts|js|jsx|tsx|java|py|go|cs|php|sh|json|yaml|yml"
  target_path:
    description: "Directory paths or files to be investigated."
    required: true
    default: "."
  exclude_patterns:
    description: "Regex of ignored."
    required: false
    default: "node_modules|dist|build|.git"

outputs:
  json:
    description: "Generated JSON file path (array)."
    value: ${{ steps.generate_output.outputs.json }}
  report_path:
    description: "Generated JSON file path (array)."
    value: ${{ steps.generate_output.outputs.report_path }}
  status:
    description: "Scan status."
    value: ${{ steps.generate_output.outputs.status }}
  count:
    description: "Number of literals found."
    value: ${{ steps.generate_output.outputs.count }}

runs:
  using: "composite"
  steps:
    - id: check_perms
      shell: bash
      env:
        TOKEN: ${{ inputs.token }}
        TARGET_PATH: ${{ inputs.target_path }}
      run: |
        set -euo pipefail
        if [ -z "$TOKEN" ]; then
          echo "âŒ Token missing."
          exit 1
        fi
        if [ -z "$TARGET_PATH" ]; then
          echo "âŒ Target path missing."
          exit 1
        fi
        for ROOT in $TARGET_PATH; do
          if [ ! -d "$ROOT" ] && [ ! -f "$ROOT" ]; then
            echo "âŒ Invalid path in TARGET_PATH: $ROOT"
            exit 1
          fi
        done

    - id: scan
      name: "ðŸ”Ž Scanning hardcode"
      shell: bash
      env:
        EXTS: ${{ inputs.file_extensions }}
        EXCLUDE: ${{ inputs.exclude_patterns }}
        TARGET_PATH: ${{ inputs.target_path }}
      run: |
        set -euo pipefail
        echo "EXTS: $EXTS"
        echo "EXCLUDE: $EXCLUDE"
        echo "TARGET_PATH: $TARGET_PATH"

        REPORT_DIR=".sentinel-reports"
        REPORT_NAME="hardcode-report.json"
        FULL_PATH="./$REPORT_DIR/$REPORT_NAME"
        mkdir -p "$REPORT_DIR"

        FILES_PATH="$(mktemp)"
        MATCHES_PATH="$(mktemp)"

        find $TARGET_PATH -type f 2>/dev/null \
          | grep -E "\.($EXTS)$" \
          | grep -vE "$EXCLUDE" \
          > "$FILES_PATH" || true

        echo "FILES:"
        head -n 3 "$FILES_PATH" || true

        PATTERN="\"[^\"]{2,}\"|'[^']{2,}'"

        if [ ! -s "$FILES_PATH" ]; then
          printf '%s\n' "[]" > "$FULL_PATH"
          echo "status=NO_FILES" >> "$GITHUB_OUTPUT"
          echo "count=0" >> "$GITHUB_OUTPUT"
          echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        xargs -r grep -HnE "$PATTERN" < "$FILES_PATH" > "$MATCHES_PATH" || true

        COUNT="$(wc -l < "$MATCHES_PATH" | tr -d ' ')"
        echo "COUNT: $COUNT"

        if [ "$COUNT" -gt "0" ]; then
          jq -R -s -c 'split("\n") | map(select(length>0))' "$MATCHES_PATH" > "$FULL_PATH"
          echo "status=FOUND" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
        else
          printf '%s\n' "[]" > "$FULL_PATH"
          echo "status=CLEAN" >> "$GITHUB_OUTPUT"
          echo "count=0" >> "$GITHUB_OUTPUT"
          echo "report_path=$FULL_PATH" >> "$GITHUB_OUTPUT"
        fi

    - id: generate_output
      shell: bash
      env:
        REPORT_PATH: ${{ steps.scan.outputs.report_path }}
        COUNT_IN: ${{ steps.scan.outputs.count }}
        STATUS_IN: ${{ steps.scan.outputs.status }}
      run: |
        set -euo pipefail
        STATUS="${STATUS_IN:-SKIPPED}"
        COUNT="${COUNT_IN:--}"
        echo "json=${REPORT_PATH:-}" >> "$GITHUB_OUTPUT"
        echo "report_path=${REPORT_PATH:-}" >> "$GITHUB_OUTPUT"
        echo "status=$STATUS" >> "$GITHUB_OUTPUT"
        echo "count=$COUNT" >> "$GITHUB_OUTPUT"
